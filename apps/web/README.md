# Mimy — Web (Farcaster Mini App)

This folder contains the Next.js front-end for the Mimy Farcaster mini-app: a perks distribution app that gates perks behind Self Protocol identity verification and (for some perks) an IRL NFC HaLo EIP-712/ECDSA signature.

**Quick summary**
- **Purpose:** Allow users to verify with Self Protocol to view and claim perks distributed via a Farcaster mini-app and on Celo.
- **IRL Gate:** Some perks require tapping an NFC HaLo bracelet to create an EIP-191 / EIP-712 signature used to authorize a claim.
- **Tech stack:** `Next.js` (app-router), `TypeScript`, `Tailwind CSS`, `Self Protocol` (`@selfxyz/*`), `Farcaster` mini-app libs, `libhalo` (HaLo NFC), and `wagmi/viem` for blockchain interactions.

**Where to look**
- Source: `src/`
- Key components: `src/components/self-verify.tsx`, `src/app/verified/page.tsx` (claim UI and HaLo flow)
- NFC helpers: `src/lib/halo.ts` (HaLo wrappers)
- Self verification API: `src/app/api/verify/route.ts`
- Notification helper (Farcaster): `src/lib/notification-client.ts`
- Env helpers: `src/lib/env.ts`
- Manifest/.well-known: `src/app/.well-known/farcaster.json/route.ts`

**Local dev**
- Install (from repo root):

  ```bash
  pnpm install
  pnpm --filter web dev
  # or
  cd apps/web && pnpm dev
  ```

- Build:

  ```bash
  pnpm --filter web build
  pnpm --filter web start
  ```

**Important environment variables**
- See `apps/web/.env.template` for defaults. Key variables developers must set:
  - `NEXT_PUBLIC_URL`: public app URL (e.g. `http://localhost:3000` or your ngrok domain)
  - `NEXT_PUBLIC_APP_ENV`: `development` or `production`
  - `JWT_SECRET`: backend JWT secret (server-side)
  - `NEXT_PUBLIC_FARCASTER_HEADER`, `NEXT_PUBLIC_FARCASTER_PAYLOAD`, `NEXT_PUBLIC_FARCASTER_SIGNATURE`: Farcaster mini-app manifest values used for the mini-app registration
  - `NEXT_PUBLIC_SELF_APP_NAME`, `NEXT_PUBLIC_SELF_SCOPE`, `NEXT_PUBLIC_SELF_ENDPOINT`: Self Protocol configuration (some also live in `self-verify` component defaults)

**Verification flow (Self Protocol)**
- UI: The homepage (`/`) shows a verification gate implemented in `src/components/self-verify.tsx`.
- User action:
  1. Click “Verify with Self Protocol” opens a modal/QR generated by `@selfxyz/qrcode`.
 2. Scan the QR / open the universal link with the Self app.
 3. After completing the disclosure (minimum age 18, nationality, gender by default), the Self app posts a proof to the configured backend endpoint.
 4. The backend endpoint `POST /api/verify` (`src/app/api/verify/route.ts`) receives `{ attestationId, proof, publicSignals, userContextData }` and uses `@selfxyz/core` to validate the proof.
 5. If verification succeeds, the user is redirected internally to `/verified` where perks are visible.

**Perks & Claiming flow**
- On `src/app/verified/page.tsx` the UI lists perks (sample `SAMPLE_PERKS`) and opens a details sheet when a perk is selected.
- For perks that are distributed digitally (tokens) the flow is: user selects a perk → the UI asks the user to sign with HaLo (NFC) → the HaLo signature is shown and the app can submit the signature + claimant address to a backend/contract to finalize the claim.

**HaLo NFC integration (IRL signature)**
- Implementation: `src/lib/halo.ts` wraps the `@arx-research/libhalo` web API (`execHaloCmdWeb`). It exposes helpers:
  - `getHaloInfo()` / `getHaloKeyInfo()` — read keys and status
  - `signMessage(message, keyNo, format)` — EIP-191 / personal_sign friendly signing
  - `signDigest(digest, keyNo)` — raw ECDSA signing of 32-byte digest
  - `signTypedData(typedData, keyNo)` — EIP-712 typed data signing
- Example usage is in `src/app/verified/page.tsx` where a friendly message is built (e.g. `Claim 500 tokens to <address>`) and `signMessage` is invoked. The resulting signature object includes `signature.ether` and `etherAddress` to prove the signer.
- For a stricter on-chain claim flow you should use `signTypedData` (EIP-712) with a domain matching your contract to avoid replay across chains/contracts.

**EIP-712 / On-chain verification notes**
- If you intend to validate signatures on-chain, use `signTypedData` to produce a typed signature whose domain contains `chainId` and `verifyingContract`.
- The smart contract should verify the signature against an expected signer address (the HaLo public key address) using `ecrecover` or a verifier library.

**Farcaster mini-app integration**
- This app is built to be used as a Farcaster mini-app. The manifest header/payload/signature are expected as `NEXT_PUBLIC_FARCASTER_*` env vars (see `.env.template`).
- There is a `.well-known` and mini-app manifest route at `src/app/.well-known/farcaster.json/route.ts` used for the Farcaster discovery.

**Backend routes (Next API routes)**
- `POST /api/verify` — validates Self proof via `@selfxyz/core` (see `src/app/api/verify/route.ts`).
- `POST /api/auth/sign-in` — Farcaster sign-in (see `src/app/api/auth/sign-in/route.ts`).
- `POST /api/webhook` and `POST /api/notify` — sample webhook / notify endpoints showing Farcaster notifications and webhook integration.

**Security & privacy notes**
- Self Protocol: the app requests a minimal set of disclosures by default (`minimumAge: 18`, `nationality`, `gender`). The verification component and server verify the cryptographic proof — private data stays on the user device where possible.
- Do not store raw PII unless necessary. If you persist verification results, store only the minimal attributes needed (e.g., a boolean `isVerified`, country code, and a timestamp).
- Keep `JWT_SECRET` and other server-only secrets out of client envs. Use server environment vars for signing and token issuance.

**Troubleshooting**
- QR code doesn't load: ensure `NEXT_PUBLIC_SELF_ENDPOINT` and `NEXT_PUBLIC_SELF_APP_NAME` are set and reachable from the Self app.
- Farcaster mini-app errors: ensure the `NEXT_PUBLIC_FARCASTER_*` manifest values match the Farcaster developer manifest for your domain (use ngrok for local testing and update `NEXT_PUBLIC_URL`).
- HaLo not responding: confirm the browser supports the HaLo web APIs and that `@arx-research/libhalo` is accessible. Check console logs — `src/lib/halo.ts` logs errors.
